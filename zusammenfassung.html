<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<title>Zusammenfassung</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
.buttons-container { margin-top: 30px; text-align: center; }
    .buttons-container button { padding: 10px 18px; margin: 5px; cursor: pointer; }
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 10px; }
    th { background-color: #eee; }
  </style>
</head>
<body><div id="content-to-pdf">
<h1 style="text-align: center;">Zusammenfassung der MaÃŸnahmen</h1>
<form id="metaForm" style="margin-bottom: 30px; display: flex; gap: 20px; flex-wrap: wrap;">
  <label>Marktnummer:
    <input type="text" id="marktnummer" />
  </label><br />
  <label>Name:
    <input type="text" id="name" />
  </label><br />
  <label>Sifa:
    <input type="text" id="sifa" />
  </label><br />
  <label>Datum:
    <input id="datum" readonly="" type="text"/></p>
  </label>
</form>
<table id="summary">
<thead><tr><th>Frage</th><th>Hinweis</th></tr></thead>
<tbody></tbody>
</table><div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;"></div>
<div class="buttons-container">
<button onclick="window.print()">ðŸ“„ Drucken / PDF</button>
<button onclick="sharePDF()">ðŸ“¤ PDF teilen (iPad)</button>
</div></div><script>
window.onload = function () {
  const urlParams = new URLSearchParams(window.location.search);
  const dataParam = urlParams.get("data");
  const tbody = document.querySelector("#summary tbody");

  function escapeHTML(str) {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  let daten = [];

  if (dataParam) {
    try {
      daten = JSON.parse(decodeURIComponent(dataParam));
    } catch (err) {
      console.error("Fehler beim Parsen der URL-Daten:", err);
    }
  } else {
    const gespeichert = localStorage.getItem("neinAntworten");
    if (gespeichert) {
      try {
        daten = JSON.parse(gespeichert).map(([frage, hinweis]) => ({ frage, hinweis }));
      } catch (err) {
        console.error("Fehler beim Laden aus localStorage:", err);
      }
    }
  }

  if (!daten.length) {
    alert("Keine Daten vorhanden. Bitte zuerst die Checkliste ausfÃ¼llen.");
    return;
  }

  daten.forEach(eintrag => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHTML(eintrag.frage)}</td><td>${escapeHTML(eintrag.hinweis)}</td>`;
    tbody.appendChild(tr);
  });
};
</script><script>
async function sharePDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'pt', 'a4');
  const content = document.getElementById("content-to-pdf") || document.body;

  const canvas = await html2canvas(content, { scale: 2, scrollY: -window.scrollY });
  const imgData = canvas.toDataURL('image/png');

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 30;
  const usableWidth = pageWidth - 2 * margin;
  const imgHeight = (canvas.height * usableWidth) / canvas.width;

  let heightLeft = imgHeight;
  let position = 0;

  pdf.addImage(imgData, 'PNG', margin, margin, usableWidth, imgHeight);
  heightLeft -= pageHeight - 2 * margin;

  while (heightLeft > 0) {
    position -= pageHeight - 2 * margin;
    pdf.addPage();
    pdf.addImage(imgData, 'PNG', margin, position + margin, usableWidth, imgHeight);
    heightLeft -= pageHeight - 2 * margin;
  }

  const blob = pdf.output('blob');
  const file = new File([blob], 'zusammenfassung.pdf', { type: 'application/pdf' });

  if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({
        title: 'Zusammenfassung â€žNeinâ€œ-Antworten',
        files: [file]
      });
    } catch (err) {
      console.error('Teilen fehlgeschlagen:', err);
      pdf.save('zusammenfassung.pdf');
    }
  } else if (navigator.share) {
    const blobUrl = URL.createObjectURL(file);
    try {
      await navigator.share({
        title: 'Zusammenfassung â€žNeinâ€œ-Antworten',
        url: blobUrl
      });
    } catch (err) {
      console.error('Fallback Teilen fehlgeschlagen:', err);
      pdf.save('zusammenfassung.pdf');
    }
  } else {
    pdf.save('zusammenfassung.pdf');
  }
}
</script>
<script>
    // Datum setzen
    const heute = new Date();
    const datumString = heute.toLocaleDateString('de-DE');
    document.getElementById('datum').value = datumString;
  </script>
</body>
</html>

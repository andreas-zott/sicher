<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbeitssicherheit-Checkliste-2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="p-3">
  <div class="container">
    <h1 class="mb-4 text-center">Arbeitssicherheit-Checkliste-2025</h1>
    <form id="formular" class="mb-4">
      <div class="mb-3">
        <label for="datum" class="form-label">Datum:</label>
        <input type="date" id="datum" name="datum" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="marktnummer" class="form-label">Marktnummer:</label>
        <input type="text" id="marktnummer" name="marktnummer" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        <input type="text" id="name" name="name" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="sifa" class="form-label">SiFa:</label>
        <input type="text" id="sifa" name="sifa" class="form-control" required />
      </div>

      <!-- Fragen-Tabelle -->
      <table id="fragenTabelle" class="table table-bordered">
        <tr>
          <th>Frage</th>
          <th>Ja</th>
          <th>Nein</th>
          <th>Nicht vorhanden</th>
        </tr>
        <tr>
          <td>Wird Alleinarbeit vermieden?</td>
          <td><input type="radio" name="frage1" value="ja" /></td>
          <td><input type="radio" name="frage1" value="nein" /></td>
          <td><input type="radio" name="frage1" value="nicht_vorhanden" /></td>
        </tr>
        <tr>
          <td>Sind Fluchtwege freigehalten?</td>
          <td><input type="radio" name="frage2" value="ja" /></td>
          <td><input type="radio" name="frage2" value="nein" /></td>
          <td><input type="radio" name="frage2" value="nicht_vorhanden" /></td>
        </tr>
        <tr>
          <td>Sind Feuerl√∂scher zug√§nglich und gepr√ºft?</td>
          <td><input type="radio" name="frage3" value="ja" /></td>
          <td><input type="radio" name="frage3" value="nein" /></td>
          <td><input type="radio" name="frage3" value="nicht_vorhanden" /></td>
        </tr>
        <tr>
          <td>Ist die pers√∂nliche Schutzausr√ºstung vorhanden?</td>
          <td><input type="radio" name="frage4" value="ja" /></td>
          <td><input type="radio" name="frage4" value="nein" /></td>
          <td><input type="radio" name="frage4" value="nicht_vorhanden" /></td>
        </tr>
        <tr>
          <td>Ist der Erste-Hilfe-Kasten vollst√§ndig?</td>
          <td><input type="radio" name="frage5" value="ja" /></td>
          <td><input type="radio" name="frage5" value="nein" /></td>
          <td><input type="radio" name="frage5" value="nicht_vorhanden" /></td>
        </tr>
      </table>

      <div class="mb-3">
        <label for="upload" class="form-label">Fotos (max 16):</label>
        <input type="file" id="upload" accept="image/*" multiple class="form-control" />
      </div>
      <div id="vorschauContainer" class="mb-3"></div>

      <button type="button" class="btn btn-success w-100 mb-2" onclick="speichernAlsPDF()">üíæ Als PDF speichern</button>
      <button type="button" class="btn btn-warning w-100" onclick="zeigeDebugInfo()">üß™ Debug: Ger√§t & Browser</button>
    </form>
  </div>

  <script>
    const uploadInput = document.getElementById("upload");
    const vorschauContainer = document.getElementById("vorschauContainer");
    let bilder = [];

    uploadInput.addEventListener("change", handleFile);
    function handleFile(event) {
      const files = event.target.files;
      for (const file of files) {
        if (file && file.type.startsWith("image/") && bilder.length < 16) {
          const reader = new FileReader();
          reader.onload = function (e) {
            bilder.push(e.target.result);
            renderVorschau();
          };
          reader.readAsDataURL(file);
        }
      }
      event.target.value = "";
    }

    function renderVorschau() {
      vorschauContainer.innerHTML = "";
      bilder.forEach((src, index) => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Bild " + (index + 1);
        img.style.maxHeight = "100px";
        img.style.marginRight = "10px";
        vorschauContainer.appendChild(img);
      });
    }

    function isSafariOniPad() {
      const ua = navigator.userAgent;
      const isIOS = /iPad|Macintosh/.test(ua) && 'ontouchend' in document;
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      return isIOS && isSafari;
    }

    function zeigeDebugInfo() {
      const ua = navigator.userAgent;
      const istSafariOniPad = isSafariOniPad();
      const kannTeilen = navigator.canShare ? navigator.canShare({ files: [] }) : false;

      alert(`üì± User-Agent:\n${ua}\n\nüß† isSafariOniPad(): ${istSafariOniPad}\nüì§ navigator.canShare(): ${kannTeilen}`);
    }

    async function speichernAlsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const datum = document.getElementById("datum").value.trim();
      const marktnummer = document.getElementById("marktnummer").value.trim();
      const name = document.getElementById("name").value.trim();
      const sifa = document.getElementById("sifa").value.trim();

      if (!datum || !marktnummer || !name || !sifa) {
        alert("Bitte f√ºlle alle Pflichtfelder aus.");
        return;
      }

      doc.setFontSize(12);
      let yPos = 20;
      doc.text(`Datum: ${datum}`, 10, yPos); yPos += 7;
      doc.text(`Marktnummer: ${marktnummer}`, 10, yPos); yPos += 7;
      doc.text(`Name: ${name}`, 10, yPos); yPos += 7;
      doc.text(`SiFa: ${sifa}`, 10, yPos); yPos += 10;

      const fragenTabelle = document.getElementById("fragenTabelle");
      const rows = fragenTabelle.querySelectorAll("tr");

      const colWidths = [110, 25, 25, 40];
      const cellHeight = 10;

      doc.setDrawColor(0);
      doc.setLineWidth(0.1);
      doc.setFont("helvetica", "normal");

      let x = 10;
      const headers = ["Frage", "Ja", "Nein", "Nicht vorhanden"];
      for (let i = 0; i < headers.length; i++) {
        doc.rect(x, yPos, colWidths[i], cellHeight);
        doc.text(headers[i], x + 2, yPos + 7);
        x += colWidths[i];
      }
      yPos += cellHeight;

      rows.forEach(row => {
        const frage = row.querySelector("td")?.innerText?.trim();
        if (!frage) return;

        const inputs = row.querySelectorAll("input[type='radio']");
        const name = inputs[0]?.name;
        const selected = document.querySelector(`input[name="${name}"]:checked`)?.value;

        const values = ["ja", "nein", "nicht_vorhanden"];
        const symbols = values.map(val => (selected === val ? "‚óè" : ""));

        x = 10;
        doc.rect(x, yPos, colWidths[0], cellHeight);
        doc.text(frage, x + 2, yPos + 7);
        x += colWidths[0];

        for (let i = 0; i < 3; i++) {
          doc.rect(x, yPos, colWidths[i + 1], cellHeight);
          if (symbols[i]) doc.text(symbols[i], x + colWidths[i + 1] / 2 - 2, yPos + 7);
          x += colWidths[i + 1];
        }

        yPos += cellHeight;
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
      });

      // Bilder
      const margin = 10;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const maxWidth = (pageWidth - margin * 3) / 2;
      const maxHeight = 70;
      let xPos = margin;

      for (let i = 0; i < bilder.length; i++) {
        const img = bilder[i];
        const imgProps = doc.getImageProperties(img);
        let imgWidth = maxWidth;
        let imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        if (imgHeight > maxHeight) {
          imgHeight = maxHeight;
          imgWidth = (imgProps.width * imgHeight) / imgProps.height;
        }
        if (yPos + imgHeight + margin > pageHeight) {
          doc.addPage();
          yPos = 20;
          xPos = margin;
        }
        doc.addImage(img, 'JPEG', xPos, yPos, imgWidth, imgHeight);
        if (xPos + imgWidth * 2 <= pageWidth) {
          xPos += imgWidth + margin;
        } else {
          xPos = margin;
          yPos += imgHeight + margin;
        }
      }

      const blob = doc.output("blob");
      const file = new File([blob], `Checkliste-${datum}.pdf`, { type: "application/pdf" });

      if (isSafariOniPad() && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: "Checkliste Arbeitssicherheit",
            text: "Hier ist die generierte PDF-Datei.",
            files: [file]
          });
        } catch (err) {
          alert("Teilen wurde abgebrochen oder ist fehlgeschlagen.");
        }
      } else {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Checkliste-${datum}.pdf`;
        link.click();
      }

      document.getElementById("formular").reset();
      bilder = [];
      renderVorschau();
    }

    document.getElementById("datum").valueAsDate = new Date();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbeitssicherheit-Checkliste-2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Scrollbar fÃ¼r Tabelle (kleinere GerÃ¤te) */
    #checklist-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 0.25rem;
      background: #f8f9fa;
    }
    table th, table td {
      vertical-align: middle;
      text-align: center;
    }
    table td:first-child {
      text-align: left;
    }
  </style>
</head>
<body class="p-3">

  <div class="container">
    <h1 class="mb-4 text-center">Arbeitssicherheit-Checkliste-2025</h1>
    <form id="formular" class="mb-4">
      <div class="mb-3">
        <label for="datum" class="form-label">Datum:</label>
        <input type="date" id="datum" name="datum" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="marktnummer" class="form-label">Marktnummer:</label>
        <input type="text" id="marktnummer" name="marktnummer" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        <input type="text" id="name" name="name" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="sifa" class="form-label">SiFa:</label>
        <input type="text" id="sifa" name="sifa" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="upload" class="form-label">Fotos (max 16):</label>
        <input type="file" id="upload" accept="image/*" multiple class="form-control" />
      </div>
      <div id="vorschauContainer" class="mb-3 d-flex flex-wrap gap-2"></div>

      <div id="checklist-container">
        <table id="checklist" class="table table-striped table-bordered mb-0">
          <thead class="table-light">
            <tr>
              <th>Frage</th>
              <th>Ja</th>
              <th>Nein</th>
              <th>Nicht vorhanden</th>
            </tr>
          </thead>
          <tbody id="checklist-body">
            <!-- Fragen kommen per JS -->
          </tbody>
        </table>
      </div>

      <button type="button" class="btn btn-success w-100 mb-2" onclick="speichernAlsPDF()">ðŸ’¾ Als PDF speichern</button>
      <button type="button" class="btn btn-warning w-100" onclick="zeigeDebugInfo()">ðŸ§ª Debug: GerÃ¤t & Browser</button>
    </form>
  </div>

  <script>
    // Fragen-Array
    const fragen = [
      "Im gesamten Markt wird geeignetes Schuhwerk getragen (feste, geschlossene, flache Schuhe)",
      "AutomatiktÃ¼ren, Rolltore, Schnelllauftore sind geprÃ¼ft und ohne sichtbare BeschÃ¤digungen",
      "Die Aufzugsanlage ist geprÃ¼ft und in einem ordnungsgemÃ¤ÃŸen Zustand",
      "Die LeergutrÃ¼cknahme ist in einem ordnungsgemÃ¤ÃŸen Zustand",
      "Die Leitern sind geprÃ¼ft und dokumentiert",
      "Es werden geeignete Sicherheitsmesser verwendet",
      "Keine sichtbaren BeschÃ¤digungen an Schaltern/Steckdosen",
      "Gabelhubwagen ist in einem ordnungsgemÃ¤ÃŸen Zustand",
      "Elektrischer Hubwagen ist geprÃ¼ft und gesichert",
      "FeuerlÃ¶scheinrichtungen sind frei zugÃ¤nglich",
      "FeuerlÃ¶scher sind geprÃ¼ft (PrÃ¼ffristen eingehalten)",
      "BrandschutztÃ¼ren sind nicht zugestellt",
      "TÃ¼rhaltevorrichtungen sind in Ordnung",
      "BrandschutztÃ¼ren sind ohne BeschÃ¤digung",
      "Flucht- und Rettungsplan ist aktuell vorhanden",
      "Notausgangsbeleuchtung ohne Defekte",
      "NotausgÃ¤nge sind frei zugÃ¤nglich",
      "NotausgÃ¤nge sind von innen ohne fremde Hilfe zu Ã¶ffnen",
      "NotausgÃ¤nge fÃ¼hren in sichere Bereiche",
      "Verkehrswege sind sicher (keine Stolperstellen)",
      "Treppen sind unbeschÃ¤digt und frei",
      "PersÃ¶nliche SchutzausrÃ¼stung ist verfÃ¼gbar",
      "TechnikrÃ¤ume werden nicht als LagerrÃ¤ume genutzt",
      "Betriebsanweisungen sind gut zugÃ¤nglich"
    ];

    // Checkliste in Tabelle rendern
    const tbody = document.getElementById("checklist-body");
    fragen.forEach((frage, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="text-start">${frage}</td>
        <td><input type="radio" name="frage${i}" value="Ja" required></td>
        <td><input type="radio" name="frage${i}" value="Nein"></td>
        <td><input type="radio" name="frage${i}" value="Nicht vorhanden"></td>
      `;
      tbody.appendChild(tr);
    });

    // Bilder Upload & Vorschau
    const uploadInput = document.getElementById("upload");
    const vorschauContainer = document.getElementById("vorschauContainer");
    let bilder = [];

    uploadInput.addEventListener("change", handleFile);

    function handleFile(event) {
      const files = event.target.files;
      for (const file of files) {
        if (file && file.type.startsWith("image/") && bilder.length < 16) {
          const reader = new FileReader();
          reader.onload = function (e) {
            bilder.push(e.target.result);
            renderVorschau();
          };
          reader.readAsDataURL(file);
        }
      }
      event.target.value = "";
    }

    function renderVorschau() {
      vorschauContainer.innerHTML = "";
      bilder.forEach((src, index) => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Bild " + (index + 1);
        img.style.maxHeight = "100px";
        img.style.borderRadius = "4px";
        img.style.boxShadow = "0 0 5px rgba(0,0,0,0.1)";
        vorschauContainer.appendChild(img);
      });
    }

    // iPad Safari Check
    function isSafariOniPad() {
      const ua = navigator.userAgent;
      const isIOS = /iPad|Macintosh/.test(ua) && 'ontouchend' in document;
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      return isIOS && isSafari;
    }

    // Debug Info anzeigen
    function zeigeDebugInfo() {
      const ua = navigator.userAgent;
      const istSafariOniPad = isSafariOniPad();
      const kannTeilen = navigator.canShare ? navigator.canShare({ files: [] }) : false;

      alert(
        `ðŸ“± User-Agent:\n${ua}\n\n` +
        `ðŸ§  isSafariOniPad(): ${istSafariOniPad}\n` +
        `ðŸ“¤ navigator.canShare(): ${kannTeilen}`
      );
    }

    async function speichernAlsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Pflichtfelder prÃ¼fen
      const datum = document.getElementById("datum").value.trim();
      const marktnummer = document.getElementById("marktnummer").value.trim();
      const name = document.getElementById("name").value.trim();
      const sifa = document.getElementById("sifa").value.trim();

      if (!datum || !marktnummer || !name || !sifa) {
        alert("Bitte fÃ¼lle alle Pflichtfelder aus.");
        return;
      }

      // PrÃ¼fen, ob alle Fragen beantwortet sind
      for (let i = 0; i < fragen.length; i++) {
        const radios = document.getElementsByName(`frage${i}`);
        if (![...radios].some(r => r.checked)) {
          alert(`Bitte beantworte Frage ${i+1}: "${fragen[i]}"`);
          return;
        }
      }

      // Kopfzeile
      doc.setFontSize(14);
      let yPos = 20;
      doc.text(`Datum: ${datum}`, 10, yPos); yPos += 10;
      doc.text(`Marktnummer: ${marktnummer}`, 10, yPos); yPos += 10;
      doc.text(`Name: ${name}`, 10, yPos); yPos += 10;
      doc.text(`SiFa: ${sifa}`, 10, yPos); yPos += 15;

      // Checkliste auslesen und ins PDF schreiben (zweispaltig)
      doc.setFontSize(12);
      const margin = 10;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      const lineHeight = 7;
      let xPos = margin;
      let startY = yPos;
      const colWidth = (pageWidth - 3 * margin) / 2;

      for (let i = 0; i < fragen.length; i++) {
        // Frage
        const frageText = fragen[i];
        // Antwort ermitteln
        const radios = document.getElementsByName(`frage${i}`);
        let antwort = "";
        for (const r of radios) {
          if (r.checked) {
            antwort = r.value;
            break;
          }
        }

        // Frage + Antwort in einer Zeile
        let text = `${i+1}. ${frageText}: ${antwort}`;

        // Text in Spalte einpassen (Zeilenumbruch)
        const splitted = doc.splitTextToSize(text, colWidth);

        // Seitenumbruch prÃ¼fen
        if (startY + lineHeight * splitted.length > pageHeight - margin) {
          doc.addPage();
          startY = margin;
        }

        doc.text(splitted, xPos, startY);
        startY += lineHeight * splitted.length;

        // Spaltenwechsel nach HÃ¤lfte der Fragen
        if (i === Math.floor(fragen.length/2) -1) {
          xPos = colWidth + 2 * margin;
          startY = yPos;
        }
      }

      // Bilder hinzufÃ¼gen (max 16), max 2 pro Reihe
      const maxImgWidth = (pageWidth - margin * 3) / 2;
      const maxImgHeight = 60;
      let imgX = margin;
      let imgY = startY + 10;

      for (let i = 0; i < bilder.length; i++) {
        const img = bilder[i];
        try {
          const imgProps = doc.getImageProperties(img);
          let imgWidth = maxImgWidth;
          let imgHeight = (imgProps.height * imgWidth) / imgProps.width;
          if (imgHeight > maxImgHeight) {
            imgHeight = maxImgHeight;
            imgWidth = (imgProps.width * imgHeight) / imgProps.height;
          }

          if (imgY + imgHeight > pageHeight - margin) {
            doc.addPage();
            imgY = margin;
            imgX = margin;
          }

          doc.addImage(img, 'JPEG', imgX, imgY, imgWidth, imgHeight);

          if (imgX + imgWidth * 2 + margin <= pageWidth) {
            imgX += imgWidth + margin;
          } else {
            imgX = margin;
            imgY += imgHeight + margin;
          }
        } catch (e) {
          console.warn("Bild konnte nicht hinzugefÃ¼gt werden", e);
        }
      }

      // PDF als Blob erzeugen
      const blob = doc.output("blob");
      const file = new File([blob], `Checkliste-${datum}.pdf`, { type: "application/pdf" });

      // Teilen-Funktion bei Safari auf iPad
      if (isSafariOniPad() && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: "Checkliste Arbeitssicherheit",
            text: "Hier ist die generierte PDF-Datei.",
            files: [file]
          });
        } catch (err) {
          console.error("Teilen abgebrochen oder fehlgeschlagen:", err);
          alert("Teilen wurde abgebrochen oder ist fehlgeschlagen.");
        }
      } else {
        // Herunterladen fÃ¼r andere GerÃ¤te/Browsers
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Checkliste-${datum}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Formular zurÃ¼cksetzen und Bilder lÃ¶schen
      document.getElementById("formular").reset();
      bilder = [];
      renderVorschau();
    }

    // Setze Datum auf heute
    document.getElementById("datum").valueAsDate = new Date();
  </script>
</body>
</html>

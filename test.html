<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbeitssicherheit-Checkliste-2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="p-3">
  <div class="container">
    <h1 class="mb-4 text-center">Arbeitssicherheit-Checkliste-2025</h1>
    <form id="formular" class="mb-4">
      <div class="mb-3">
        <label for="datum" class="form-label">Datum:</label>
        <input type="date" id="datum" name="datum" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="marktnummer" class="form-label">Marktnummer:</label>
        <input type="text" id="marktnummer" name="marktnummer" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        <input type="text" id="name" name="name" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="sifa" class="form-label">SiFa:</label>
        <input type="text" id="sifa" name="sifa" class="form-control" required />
      </div>

      <table class="table table-bordered" id="fragenTabelle">
        <tr>
          <td style="text-align: left;">Wird Alleinarbeit vermieden?</td>
          <td><input name="frage1" type="radio" value="ja" /></td>
          <td><input name="frage1" type="radio" value="nein" /></td>
          <td><input name="frage1" type="radio" value="nicht_vorhanden" /></td>
        </tr>
        <tr>
          <td style="text-align: left;">Ist Erste Hilfe organisiert?</td>
          <td><input name="frage2" type="radio" value="ja" /></td>
          <td><input name="frage2" type="radio" value="nein" /></td>
          <td><input name="frage2" type="radio" value="nicht_vorhanden" /></td>
        </tr>
      </table>

      <button type="button" class="btn btn-success w-100 mb-2" onclick="speichernAlsPDF()">💾 Als PDF speichern</button>
    </form>
  </div>

  <script>
    async function speichernAlsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      const datum = document.getElementById("datum").value.trim();
      const marktnummer = document.getElementById("marktnummer").value.trim();
      const name = document.getElementById("name").value.trim();
      const sifa = document.getElementById("sifa").value.trim();

      if (!datum || !marktnummer || !name || !sifa) {
        alert("Bitte fülle alle Pflichtfelder aus.");
        return;
      }

      let yPos = 20;
      doc.setFontSize(14);
      doc.text(`Datum: ${datum}`, 10, yPos); yPos += 10;
      doc.text(`Marktnummer: ${marktnummer}`, 10, yPos); yPos += 10;
      doc.text(`Name: ${name}`, 10, yPos); yPos += 10;
      doc.text(`SiFa: ${sifa}`, 10, yPos); yPos += 15;

      const fragen = document.querySelectorAll("#fragenTabelle tr");
      fragen.forEach(row => {
        const frageText = row.cells[0]?.innerText?.trim();
        const inputName = row.querySelector("input")?.name;
        const checked = document.querySelector(`input[name="${inputName}"]:checked`);
        if (!frageText || !inputName || !checked) return;

        const antwort = checked.value;
        const optionen = {
          ja: antwort === "ja" ? "✔️ Ja" : "☐ Ja",
          nein: antwort === "nein" ? "✔️ Nein" : "☐ Nein",
          nicht_vorhanden: antwort === "nicht_vorhanden" ? "✔️ Nicht vorhanden" : "☐ Nicht vorhanden"
        };

        const antwortText = `${optionen.ja}, ${optionen.nein}, ${optionen.nicht_vorhanden}`;

        if (yPos + 10 > pageHeight - 10) {
          doc.addPage();
          yPos = 20;
        }

        doc.setFont(undefined, "normal");
        doc.text(frageText, 10, yPos);
        doc.setFont(undefined, "bold");
        doc.text(antwortText, pageWidth / 2, yPos);
        yPos += 10;
      });

      const blob = doc.output("blob");
      const file = new File([blob], `Checkliste-${datum}.pdf`, { type: "application/pdf" });

      const ua = navigator.userAgent;
      const isIOS = /iPad|Macintosh/.test(ua) && 'ontouchend' in document;
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      const isSafariOniPad = isIOS && isSafari;

      if (isSafariOniPad && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: "Checkliste Arbeitssicherheit",
            text: "Hier ist die generierte PDF-Datei.",
            files: [file]
          });
        } catch (err) {
          console.error("Teilen abgebrochen oder fehlgeschlagen:", err);
          alert("Teilen wurde abgebrochen oder ist fehlgeschlagen.");
        }
      } else {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Checkliste-${datum}.pdf`;
        link.click();
      }
    }

    document.getElementById("datum").valueAsDate = new Date();
  </script>
</body>
</html>
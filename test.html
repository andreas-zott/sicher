<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbeitssicherheit-Checkliste-2025</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="p-3">

  <div class="container">
    <h1 class="mb-4 text-center">Arbeitssicherheit-Checkliste-2025</h1>
    <form id="formular" class="mb-4">
      <div class="mb-3">
        <label for="datum" class="form-label">Datum:</label>
        <input type="date" id="datum" name="datum" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="marktnummer" class="form-label">Marktnummer:</label>
        <input type="text" id="marktnummer" name="marktnummer" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        <input type="text" id="name" name="name" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="sifa" class="form-label">SiFa:</label>
        <input type="text" id="sifa" name="sifa" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="upload" class="form-label">Fotos (max 16):</label>
        <input type="file" id="upload" accept="image/*" multiple class="form-control" />
      </div>
      <div id="vorschauContainer" class="mb-3"></div>
      <button type="button" class="btn btn-success w-100 mb-2" onclick="speichernAlsPDF()">ðŸ’¾ Als PDF speichern</button>
      <button type="button" class="btn btn-warning w-100" onclick="zeigeDebugInfo()">ðŸ§ª Debug: GerÃ¤t & Browser</button>
    </form>
  </div>

  <script>
    const uploadInput = document.getElementById("upload");
    const vorschauContainer = document.getElementById("vorschauContainer");
    let bilder = [];

    uploadInput.addEventListener("change", handleFile);

    function handleFile(event) {
      const files = event.target.files;
      for (const file of files) {
        if (file && file.type.startsWith("image/") && bilder.length < 16) {
          const reader = new FileReader();
          reader.onload = function (e) {
            bilder.push(e.target.result);
            renderVorschau();
          };
          reader.readAsDataURL(file);
        }
      }
      event.target.value = "";
    }

    function renderVorschau() {
      vorschauContainer.innerHTML = "";
      bilder.forEach((src, index) => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Bild " + (index + 1);
        img.style.maxHeight = "100px";
        img.style.marginRight = "10px";
        vorschauContainer.appendChild(img);
      });
    }

    function isSafariOniPad() {
      const ua = navigator.userAgent;
      const isIOS = /iPad|Macintosh/.test(ua) && 'ontouchend' in document;
      const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
      return isIOS && isSafari;
    }

    function zeigeDebugInfo() {
      const ua = navigator.userAgent;
      const istSafariOniPad = isSafariOniPad();
      const kannTeilen = navigator.canShare ? navigator.canShare({ files: [] }) : false;

      alert(
        `ðŸ“± User-Agent:
${ua}

` +
        `ðŸ§  isSafariOniPad(): ${istSafariOniPad}
` +
        `ðŸ“¤ navigator.canShare(): ${kannTeilen}`
      );
    }

    async function speichernAlsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const datum = document.getElementById("datum").value.trim();
      const marktnummer = document.getElementById("marktnummer").value.trim();
      const name = document.getElementById("name").value.trim();
      const sifa = document.getElementById("sifa").value.trim();

      if (!datum || !marktnummer || !name || !sifa) {
        alert("Bitte fÃ¼lle alle Pflichtfelder aus.");
        return;
      }

      doc.setFontSize(14);
      let yPos = 20;
      doc.text(`Datum: ${datum}`, 10, yPos); yPos += 10;
      doc.text(`Marktnummer: ${marktnummer}`, 10, yPos); yPos += 10;
      doc.text(`Name: ${name}`, 10, yPos); yPos += 10;
      doc.text(`SiFa: ${sifa}`, 10, yPos); yPos += 15;

      const margin = 10;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const maxWidth = (pageWidth - margin * 3) / 2;
      const maxHeight = (pageHeight - yPos - margin * 3) / 2;
      let xPos = margin;

      for (let i = 0; i < bilder.length; i++) {
        const img = bilder[i];
        const imgProps = doc.getImageProperties(img);
        let imgWidth = maxWidth;
        let imgHeight = (imgProps.height * imgWidth) / imgProps.width;
        if (imgHeight > maxHeight) {
          imgHeight = maxHeight;
          imgWidth = (imgProps.width * imgHeight) / imgProps.height;
        }
        if (yPos + imgHeight + margin > pageHeight) {
          doc.addPage();
          yPos = 20;
          xPos = margin;
        }
        doc.addImage(img, 'JPEG', xPos, yPos, imgWidth, imgHeight);
        if (xPos + imgWidth * 2 <= pageWidth) {
          xPos += imgWidth + margin;
        } else {
          xPos = margin;
          yPos += imgHeight + margin;
        }
      }

      const blob = doc.output("blob");
      const file = new File([blob], `Checkliste-${datum}.pdf`, { type: "application/pdf" });

      if (isSafariOniPad() && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: "Checkliste Arbeitssicherheit",
            text: "Hier ist die generierte PDF-Datei.",
            files: [file]
          });
        } catch (err) {
          console.error("Teilen abgebrochen oder fehlgeschlagen:", err);
          alert("Teilen wurde abgebrochen oder ist fehlgeschlagen.");
        }
      } else {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Checkliste-${datum}.pdf`;
        link.click();
      }

      document.getElementById("formular").reset();
      bilder = [];
      renderVorschau();
    }

    document.getElementById("datum").valueAsDate = new Date();
  </script>
</body>
</html>

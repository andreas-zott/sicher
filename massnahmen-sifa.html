<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Ma√ünahmen-Auswertung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
* { box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%); color: #333; margin: 0; padding: 20px; line-height: 1.6; }

/* --- Tabellen & Inhalt --- */
table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 12px; overflow: hidden; page-break-inside:auto; }
tr, td, th { page-break-inside: avoid !important; }
tr:nth-child(15n) { page-break-after: always; }

.container { max-width: 1200px; margin: 0 auto; }
h1 { text-align: center; color: #C62828; font-size: 32px; margin-bottom: 30px; }
.info { background: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.info p { margin: 8px 0; font-size: 16px; }
.info strong { color: #C62828; font-weight: 600; }

th, td { padding: 16px; text-align: left; font-size: 15px; border-bottom: 1px solid #e0e0e0; }
th { background-color: #C62828; color: white; font-weight: 600; }
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background-color: #f9f9f9; }
td:nth-child(2) { font-style: italic; font-size: 0.9em; color: #555; }

.btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; margin-bottom: 40px; position: sticky; top: 20px; z-index: 100; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
button { background-color: #C62828; color: white; font-size: 16px; padding: 14px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
button:hover { background-color: #8B1F1F; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(198, 40, 40, 0.4); }
button:active { transform: translateY(0); }

@media (max-width: 800px) {
  th, td { font-size: 13px; padding: 12px; }
  button { font-size: 14px; padding: 12px 20px; width: 100%; justify-content: center; }
  .btn-group { flex-direction: column; position: static; }
  h1 { font-size: 24px; }
}

/* --- Druck / PDF --- */
@media print {
  body { background: white; padding: 0; }
  .btn-group, footer { display: none !important; }
  table { box-shadow: none; border: 1px solid #ddd; }
  th, td { padding: 10px; font-size: 11pt; }
}

/* --- Footer f√ºr Bildschirm --- */
footer {
  background: #f3f4f6;
  color: #374151;
  padding: 20px;
  margin-top: 40px;
  text-align: center;
  border-radius: 12px;
}
footer a { color: #C62828; text-decoration: none; margin: 0 12px; font-weight: 500; }
footer a:hover { text-decoration: underline; }
</style>
</head>
<body>
  <h1>üõ†Ô∏è Ma√ünahmen-Auswertung</h1>
  <div class="info" id="meta-info"></div>

  <div class="btn-group">
    <button onclick="druckMitFooterAusblenden()">üìÑ Drucken / PDF</button>
    <button onclick="pdfTeilen()" class="share-button">üìÑ PDF generieren & teilen üì§</button>
    <button onclick="teilen()" class="share-button">üßæ Text teilen (iPad)</button>
  </div>

  <table id="ma√ünahmen-tabelle">
    <thead>
      <tr>
        <th>Nr.</th>
        <th>Beschreibung der Ma√ünahme</th>
      </tr>
    </thead>
    <tbody>
      <!-- Dynamisch per JS -->
    </tbody>
  </table>

  <script>
    let aktuelleDaten = null;

    window.addEventListener('message', (event) => {
      const data = event.data;
      aktuelleDaten = data;

      document.getElementById('meta-info').innerHTML = `
        <p><strong>üóìÔ∏è Datum:</strong> ${data.datum}</p>
        <p><strong>üè¨ Marktnummer:</strong> ${data.markt}</p>
        <p><strong>üë§ Name:</strong> ${data.name}</p>
        <p><strong>üõ°Ô∏è SiFa:</strong> ${data.sifa}</p>
      `;

      const tbody = document.querySelector('#ma√ünahmen-tabelle tbody');
      if (data.ma√ünahmen.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2">üéâ Keine Ma√ünahmen erforderlich!</td></tr>`;
      } else {
        tbody.innerHTML = '';
        data.ma√ünahmen.forEach((m, i) => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${i + 1}</td><td>${m.beschreibung}</td>`;
          tbody.appendChild(row);
        });
      }
    });

    function druckMitFooterAusblenden() {
      const footer = document.querySelector("footer");
      if (footer) footer.style.display = "none";
      window.print();
      if (footer) footer.style.display = "";
    }

    async function teilen() {
      if (!aktuelleDaten) {
        alert("‚ùó Noch keine Daten empfangen.");
        return;
      }

      const text = `Ma√ünahmen√ºbersicht f√ºr Markt ${aktuelleDaten.markt} vom ${aktuelleDaten.datum}:\n\n` +
        aktuelleDaten.ma√ünahmen.map((m, i) => `${i + 1}. ${m.beschreibung}`).join("\n") +
        `\n\nName: ${aktuelleDaten.name}\nSiFa: ${aktuelleDaten.sifa}`;

      if (navigator.canShare && navigator.canShare({ text })) {
        try {
          await navigator.share({
            title: `Checkliste ${aktuelleDaten.markt}`,
            text: text
          });
        } catch (err) {
          console.error("‚ùå Teilen fehlgeschlagen", err);
        }
      } else {
        alert("‚ùå Teilen wird auf diesem Ger√§t nicht unterst√ºtzt. Bitte manuell kopieren.");
      }
    }

    // --- PDF generieren mit Seitenzahlen ---
    async function pdfTeilen() {
      if (!aktuelleDaten) {
        alert("‚ùó Noch keine Daten empfangen.");
        return;
      }

      const element = document.body.cloneNode(true);
      element.querySelector('.btn-group')?.remove();
      element.querySelector('.nav-buttons')?.remove();
      element.querySelector('footer')?.remove(); // Footer entfernen

      const opt = {
        margin: [56.7, 56.7, 56.7, 56.7],
        filename: `Ma√ünahmen-${aktuelleDaten.markt || 'markt'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, scrollY: 0 },
        jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
      };

      // Generiere PDF
      const pdf = await html2pdf().set(opt).from(element).toPdf().get('pdf').then(function (pdf) {
        const totalPages = pdf.internal.getNumberOfPages();

        // Jede Seite durchlaufen und Seitenzahl unten zentriert einf√ºgen
        for (let i = 1; i <= totalPages; i++) {
          pdf.setPage(i);
          pdf.setFontSize(10);
          pdf.setTextColor(100);
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const text = `Seite ${i} von ${totalPages}`;
          const textWidth = pdf.getTextWidth(text);
          pdf.text(text, (pageWidth - textWidth) / 2, pageHeight - 20); // 20pt Abstand vom unteren Rand
        }
        return pdf;
      });

      const blob = pdf.output('blob');
      const file = new File([blob], opt.filename, { type: "application/pdf" });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: "Ma√ünahmen-Auswertung",
            text: `PDF zur Checkliste vom ${aktuelleDaten.datum}`,
            files: [file]
          });
        } catch (err) {
          console.error("‚ùå Teilen fehlgeschlagen", err);
        }
      } else {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = opt.filename;
        link.click();
        alert("üì• PDF wurde heruntergeladen. Mailversand wird nicht unterst√ºtzt.");
      }
    }
  </script>

<footer style="
  text-align: center;
  margin-top: 40px;
  padding: 16px 8px;
  font-size: 12px;
  color: #999;
  background-color: #fafafa;
  border-top: 1px solid #eee;
  border-radius: 0 0 10px 10px;">
  ¬© <span id="year"></span> Andreas Zott ‚Äì Alle Rechte vorbehalten<br/>
<span style="font-size: 11px;">(Sifa) Arbeitssicherheit <span id="year-small"></span></span>
<div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
<div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 8px;">
<a href="impressum.html" style="color: #4f46e5; text-decoration: none; font-size: 13px;">Impressum</a>
<a href="datenschutz.html" style="color: #4f46e5; text-decoration: none; font-size: 13px;">Datenschutz</a>
</div>
<p style="margin: 0; font-size: 12px; color: #6b7280;">
</p>
</div><div style="font-size:11px; color:#777; margin-top:8px;">Stand: Oktober 2025</div>
</footer>

</body>
</html>

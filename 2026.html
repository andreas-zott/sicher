<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<title>Arbeitsschutz ‚Äë Checkliste</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<link href="/sicher/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="/sicher/manifest.json" rel="manifest"/>
<style>
.footer p {
  font-size: 12px;          /* kleinerer Text */
  color: #888888;           /* hellgraues, blasses Grau */
  margin: 0;                /* optional: etwas Abstand rausnehmen */
}
.footer a {
  color: #aaa;              /* Links auch blasser */
  text-decoration: none;    /* Optional: ohne Unterstreichung */
}
.footer a:hover {
  text-decoration: underline; /* Unterstreichung beim Hover */
}

 body { font-family: Arial, sans-serif; background-color: #eef5ff; padding: 20px; }
    h1, h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
    th, td { border: 1px solid #ccc; padding: 10px; vertical-align: top; }
    th { background-color: #ddd; }
    select { width: 100%; }
    .antwortwahl { display: none; }
    #hinweisContainer { background: #fff; padding: 20px; border: 1px solid #aaa; }
    pre { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #ccc; }
    .buttons-container { margin-top: 30px; text-align: center; }
    .buttons-container button { padding: 10px 18px; margin: 5px; cursor: pointer; }
    @media print { .buttons-container button { display: none; } }
  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="fragen.js"></script>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="Checkliste" name="apple-mobile-web-app-title"/><meta content="default" name="apple-mobile-web-app-status-bar-style"/><link href="icons/icon-192.png" rel="apple-touch-icon"/></head>
<body>
<h1 style="text-align: center;">Arbeitsschutz ‚Äë Checkliste</h1>
<form id="metaForm" style="margin-bottom: 30px; display: flex; gap: 20px; flex-wrap: wrap;">
<label>Marktnummer:
    <input id="marktnummer" type="text"/>
</label><br/>
<label>Name:
    <input id="name" type="text"/>
</label><br/>
<label>Sifa:
    <input id="sifa" type="text"/>
</label><br/>
<label>Datum:
    <input id="datum" readonly="" type="text"/>
</label>
</form>
<table id="checklist">
<thead>
<tr>
<th>Frage</th>
<th>Antwort</th>
<th>Quelle<span style="font-weight: normal"></span></th>
</tr>
</thead>
<tbody></tbody>
</table>
<h2 style="text-align: center;">Zusammenfassung der Ma√ünahmen</h2>
<table id="zusammenfassung">
<thead>
<tr><th>Frage</th><th>Hinweistext</th></tr>
</thead>
<tbody></tbody>
</table>
<div style="margin-top: 40px;">
<h3 style="text-align: center;">Unterschrift</h3>
<div style="text-align: center;">
<canvas height="200" id="signature" style="border:1px solid #ccc; background-color: white;" width="600"></canvas><br/>
<div class="buttons-container">
<button onclick="clearSignature()" type="button">üóëÔ∏è Unterschrift l√∂schen</button>
</div>
<div class="buttons-container">
<button onclick="exportMassnahmenAsHTML()">üìù Defizite exportieren</button>
<button onclick="openSummaryPage()">üìù Ma√ünahmen</button>
<button onclick="window.print()">üìÑ Drucken / PDF</button>
<button onclick="sharePDF()">üì§ PDF teilen (iPad)</button>
</div>
<script>
// Datum automatisch eintragen
document.getElementById("datum").value = new Date().toLocaleDateString("de-DE");
const tbody = document.querySelector("#checklist tbody");
const summaryBody = document.querySelector("#zusammenfassung tbody");
const antwortenMap = new Map();
function renderSummary() {
  summaryBody.textContent = "";
  antwortenMap.forEach((hinweis, frage) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${frage}</td><td>${hinweis}</td>`;
    summaryBody.appendChild(tr);
  });
}

function escapeHTML(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

if (!Array.isArray(window.fragen)) {
  alert('Fehler: Die Fragen konnten nicht geladen werden (fragen.js).');
} else {
  fragen.forEach((eintrag) => {
    const tr = document.createElement('tr');

    const tdFrage = document.createElement('td');
    tdFrage.textContent = eintrag.frage;

    const tdAntwort = document.createElement('td');
    const selectAntwort = document.createElement('select');
    ['Ja', 'Nein', 'Nicht vorhanden'].forEach((opt) => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      selectAntwort.appendChild(option);
    });
    tdAntwort.appendChild(selectAntwort);
    const tdFormWahl = document.createElement('td');
    const selectForm = document.createElement('select');
    selectForm.className = 'antwortwahl';
    selectForm.title = 'Quelle des Hinweistexts w√§hlen';
    ['bghw', 'klar', 'rechtlich'].forEach((val) => {
      const option = document.createElement('option');
      option.value = val;
      option.textContent = val.toUpperCase();
      selectForm.appendChild(option);
    });
    tdFormWahl.appendChild(selectForm);
    const updateHinweis = () => {
      if (selectAntwort.value === 'Nein') {
        const form = selectForm.value || 'bghw';
        const text = eintrag.antworten[form] || '[Kein Text hinterlegt]';
        antwortenMap.set(eintrag.frage, text);
      } else {
        antwortenMap.delete(eintrag.frage);
      }
      renderSummary();
    };

    selectAntwort.addEventListener('change', () => {
      selectForm.style.display = selectAntwort.value === 'Nein' ? 'inline-block' : 'none';
      updateHinweis();
    });
    selectForm.addEventListener('change', updateHinweis);
    tr.appendChild(tdFrage);
    tr.appendChild(tdAntwort);
    tr.appendChild(tdFormWahl);
    tbody.appendChild(tr);
  });
}
const signCanvas = document.getElementById('signature');
const signCtx = signCanvas.getContext('2d');
  signCtx.lineWidth = 2;
  signCtx.lineCap = 'round';
let signing = false;
const getPos = (e) => {
  const rect = signCanvas.getBoundingClientRect();
  if (e.touches && e.touches.length) {
    return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
  } else {
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }
};
const startSign = (e) => {
  e.preventDefault();
  signing = true;
  const pos = getPos(e);
  signCtx.beginPath();
  signCtx.moveTo(pos.x, pos.y);
};
const drawSign = (e) => {
  if (!signing) return;
  e.preventDefault();
  const pos = getPos(e);
  signCtx.lineTo(pos.x, pos.y);
  signCtx.stroke();
};
const endSign = () => {
  signing = false;
};

['mousedown', 'touchstart'].forEach(evt => signCanvas.addEventListener(evt, startSign));
['mousemove', 'touchmove'].forEach(evt => signCanvas.addEventListener(evt, drawSign));
['mouseup', 'mouseleave', 'touchend'].forEach(evt => signCanvas.addEventListener(evt, endSign));

function clearSignature() {
  signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
}


async function sharePDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'pt', 'a4');
  const pageHeight = pdf.internal.pageSize.getHeight();
  const cloned = document.body.cloneNode(true);

  const container = document.createElement('div');
  container.style.width = '800px';
  container.style.padding = '20px';
  container.style.background = 'white';
  container.style.position = 'absolute';
  container.style.top = '-10000px';
  container.appendChild(cloned);
  document.body.appendChild(container);

  const canvas = await html2canvas(container, { scale: 2 });
  const imgData = canvas.toDataURL('image/png');
  const imgWidth = pdf.internal.pageSize.getWidth();
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  let heightLeft = imgHeight;
  let position = 0;
  pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
  heightLeft -= pageHeight;
  while (heightLeft > 0) {
    position -= pageHeight;
    pdf.addPage();
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
  }

  document.body.removeChild(container);
  const pdfBlob = pdf.output('blob');
  const file = new File([pdfBlob], 'checkliste.pdf', { type: 'application/pdf' });

  try {
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({ title: 'Arbeitsschutz‚ÄëCheckliste', files: [file] });
    } else if (navigator.share) {
      const blobUrl = URL.createObjectURL(file);
      await navigator.share({ title: 'Arbeitsschutz‚ÄëCheckliste', url: blobUrl });
    } else {
      pdf.save('checkliste.pdf');
    }
  } catch (err) {
    console.error(err);
    pdf.save('checkliste.pdf');
  }
}

function exportMassnahmenAsHTML() {
  let htmlContent = `
  <!DOCTYPE html>
  <html lang="de">
  <head>
    <meta charset="UTF-8">
    <title>Exportierte Ma√ünahmen</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 10px; }
      th { background-color: #f2f2f2; }
    </style>
  </head>
  <body>
    <h1>Zusammenfassung der Ma√ünahmen</h1>
    <table>
      <thead>
        <tr><th>Frage</th><th>Hinweis</th></tr>
      </thead>
      <tbody>
  `;

  antwortenMap.forEach((hinweis, frage) => {
    htmlContent += `
      <tr>
        <td>${frage}</td>
        <td>${hinweis}</td>
      </tr>
    `;
  });

  htmlContent += `
      </tbody>
    </table>
  </body>
  </html>
  `;

  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
}
function openSummaryPage() {
  const eintraege = [];

  antwortenMap.forEach((hinweis, frage) => {
    eintraege.push({ frage, hinweis });
  });

  const datenString = encodeURIComponent(JSON.stringify(eintraege));
  const url = `zusammenfassung.html?data=${datenString}`;
  window.open(url, '_blank');
}

</script>
<p>
</p>
<p>
<footer class="footer">
<p>
    ¬© <span id="currentYear"></span> Andreas Zott. Alle Rechte vorbehalten.
    <a href="datenschutz.html" rel="noopener noreferrer" target="_blank">Datenschutz</a> |
    <a href="impressum.html" rel="noopener noreferrer" target="_blank">Impressum</a>
</p>
</footer>
<script>
  const aktuellesJahr = new Date().getFullYear();
  document.getElementById('titel').textContent = `Arbeitssicherheit-Checkliste-${aktuellesJahr}`;
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('sw.js')
        .then(() => console.log("‚úÖ Service Worker registriert"))
        .catch((err) => console.error("‚ùå Service Worker Fehler:", err));
    });
  }
</script>
</p></div></div></body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Checkliste zur Gef√§hrdungsbeurteilung im Einzelhandel</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<link href="/sicher/favicon.ico" rel="icon" type="image/x-icon" />
<link href="/sicher/2026.json" rel="manifest"/>
<style>
@media print {
  .footer {
    display: none !important;
  }
  .buttons-container button {
    display: none;
  }
}

.footer {
  text-align: center;
  margin-top: 60px;
}

.footer p {
  font-size: 12px;
  color: #888888;
  margin: 0;
}

.footer a {
  color: #aaa;
  text-decoration: none;
}

.footer a:hover {
  text-decoration: underline;
}

body {
  font-family: Arial, sans-serif;
  background-color: #eef5ff;
  padding: 20px;
  background: white !important;
  color: black !important;
}

h1, h2, h3 {
  text-align: center;
  page-break-after: avoid;
  page-break-inside: avoid;
}

/* PDF-optimierte Darstellung */
table, tr, td, th {
  page-break-inside: avoid !important;
}
#checklist, #zusammenfassung {
  page-break-inside: auto;
}

/* manuelle Umbr√ºche erzwingen */
.page-break {
  page-break-before: always;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 40px;
}

th, td {
  border: 1px solid #ccc;
  padding: 10px;
  vertical-align: top;
  font-size: 16px;
}

th {
  background-color: #ddd;
}

select {
  width: 100%;
  font-size: 14px;
}

.antwortwahl {
  display: none;
}

#metaForm,
#metaForm label,
#metaForm input {
  font-size: 16px;
}

#checklist tbody tr:nth-child(odd) {
  background-color: #f9f9f9;
}

#checklist tbody tr:nth-child(even) {
  background-color: #ffffff;
}

#hinweisContainer {
  background: #fff;
  padding: 20px;
  border: 1px solid #aaa;
}

pre {
  white-space: pre-wrap;
  background: #f9f9f9;
  padding: 10px;
  border: 1px solid #ccc;
}

.buttons-container {
  margin-top: 30px;
  text-align: center;
}

.buttons-container button {
  padding: 10px 18px;
  margin: 5px;
  cursor: pointer;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="fragen.js"></script>
</head>
<body>

<div id="pdfContent">
  <h1>Checkliste zur Gef√§hrdungsbeurteilung im Einzelhandel</h1>

  <br>
  <form id="metaForm" style="margin-bottom: 30px; display: flex; gap: 20px; flex-wrap: wrap;">
    <label>Marktnummer:
      <input type="text" id="marktnummer" />
    </label>
    <label>Name:
      <input type="text" id="name" />
    </label>
    <label>Sifa:
      <input type="text" id="sifa" />
    </label>
    <label>Datum:
      <input type="text" id="datum" readonly />
    </label>
  </form>

  <div style="text-align: center; margin: 40px 0; font-size: 18px;">
    <strong>Teil der Gef√§hrdungsbeurteilung / Wirksamkeitskontrolle</strong><br><br>
    Wenn eine Frage mit ‚Äûnein" beantwortet wurde, besteht Handlungsbedarf.
  </div>

  <br>
  <table id="checklist">
    <thead>
      <tr>
        <th>Frage</th>
        <th>Antwort</th>
        <th>Quelle</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2 class="page-break">Zusammenfassung der Ma√ünahmen</h2>
  <table id="zusammenfassung">
    <thead>
      <tr><th>Frage</th><th>Hinweistext</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Unterschrift</h3>
  <div style="text-align: center;">
    <canvas id="signature" width="600" height="200" style="border:1px solid #ccc; background-color: white;"></canvas>
  </div>
</div>

<div class="buttons-container">
  <button onclick="openSummaryPage()">üìù Defizite exportieren</button>
  <button onclick="window.print()">üìÑ Drucken / PDF</button>
  <button onclick="sharePDF()">üì§ PDF teilen (iPad)</button>
  <button type="button" onclick="clearSignature()">üóëÔ∏è Unterschrift l√∂schen</button>
</div>

<footer class="footer">
  <p>
    &copy; <span id="currentYear"></span> Andreas Zott ‚Äì Alle Rechte vorbehalten.
    <a href="datenschutz.html" rel="noopener noreferrer" target="_blank">Datenschutz</a> |
    <a href="impressum.html" rel="noopener noreferrer" target="_blank">Impressum</a>
  </p>
</footer>

<script>
// Datum setzen
const heute = new Date();
const tag = String(heute.getDate()).padStart(2, '0');
const monat = String(heute.getMonth() + 1).padStart(2, '0');
const jahr = heute.getFullYear();
document.getElementById("datum").value = `${tag}.${monat}.${jahr}`;
document.getElementById("currentYear").textContent = jahr;

const tbody = document.querySelector("#checklist tbody");
const summaryBody = document.querySelector("#zusammenfassung tbody");
const antwortenMap = new Map();

function renderSummary() {
  summaryBody.textContent = "";
  antwortenMap.forEach((hinweis, frage) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${frage}</td><td>${hinweis}</td>`;
    summaryBody.appendChild(tr);
  });
}

if (!Array.isArray(window.fragen)) {
  alert('Fehler: Die Fragen konnten nicht geladen werden (fragen.js).');
} else {
  fragen.forEach((eintrag) => {
    const tr = document.createElement('tr');
    const tdFrage = document.createElement('td');
    tdFrage.textContent = eintrag.frage;

    const tdAntwort = document.createElement('td');
    const selectAntwort = document.createElement('select');
    ['Ja', 'Nein', 'Nicht vorhanden'].forEach((opt) => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      selectAntwort.appendChild(option);
    });
    tdAntwort.appendChild(selectAntwort);

    const tdFormWahl = document.createElement('td');
    const selectForm = document.createElement('select');
    selectForm.className = 'antwortwahl';
    ['bghw', 'normal', 'rechtlich'].forEach((val) => {
      const option = document.createElement('option');
      option.value = val;
      option.textContent = val.toUpperCase();
      selectForm.appendChild(option);
    });
    tdFormWahl.appendChild(selectForm);

    const updateHinweis = () => {
      if (selectAntwort.value === 'Nein') {
        const form = selectForm.value || 'bghw';
        const text = eintrag.antworten[form] || '[Kein Text hinterlegt]';
        antwortenMap.set(eintrag.frage, text);
      } else {
        antwortenMap.delete(eintrag.frage);
      }
      renderSummary();
    };

    selectAntwort.addEventListener('change', () => {
      selectForm.style.display = selectAntwort.value === 'Nein' ? 'inline-block' : 'none';
      updateHinweis();

      if (selectAntwort.value === 'Ja') {
        tr.style.backgroundColor = '#e0f8e0';
      } else if (selectAntwort.value === 'Nein') {
        tr.style.backgroundColor = '#fbeaea';
      } else if (selectAntwort.value === 'Nicht vorhanden') {
        tr.style.backgroundColor = '#fff8dc';
      } else {
        tr.style.backgroundColor = '';
      }
    });

    selectForm.addEventListener('change', updateHinweis);

    tr.appendChild(tdFrage);
    tr.appendChild(tdAntwort);
    tr.appendChild(tdFormWahl);
    tbody.appendChild(tr);
  });
}

// Signatur
const signCanvas = document.getElementById('signature');
const signCtx = signCanvas.getContext('2d');
let signing = false;

const getPos = (e) => {
  const rect = signCanvas.getBoundingClientRect();
  if (e.touches && e.touches.length) {
    return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
  } else {
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }
};

const startSign = (e) => {
  e.preventDefault();
  signing = true;
  const pos = getPos(e);
  signCtx.beginPath();
  signCtx.moveTo(pos.x, pos.y);
};

const drawSign = (e) => {
  if (!signing) return;
  e.preventDefault();
  const pos = getPos(e);
  signCtx.lineTo(pos.x, pos.y);
  signCtx.stroke();
};

const endSign = () => { signing = false; };
['mousedown','touchstart'].forEach(evt=>signCanvas.addEventListener(evt,startSign));
['mousemove','touchmove'].forEach(evt=>signCanvas.addEventListener(evt,drawSign));
['mouseup','mouseleave','touchend'].forEach(evt=>signCanvas.addEventListener(evt,endSign));

function clearSignature() {
  signCtx.clearRect(0, 0, signCanvas.width, signCanvas.height);
}

// PDF Export mit automatischen Umbr√ºchen
async function sharePDF() {
  const element = document.getElementById('pdfContent');
  const opt = {
    margin:       [20, 20, 20, 20],
    filename:     'Begehungsprotokoll.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
    jsPDF:        { unit: 'pt', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['css', 'legacy'] }
  };

  const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
  const file = new File([pdfBlob], 'Begehungsprotokoll.pdf', { type: 'application/pdf' });

  if (navigator.share && navigator.canShare({ files: [file] })) {
    navigator.share({ title: 'Arbeitsschutz-Checkliste', files: [file] })
      .catch(err => console.error(err));
  } else {
    html2pdf().set(opt).from(element).save();
  }
}

function openSummaryPage() {
  const markt = document.getElementById('marktnummer').value.trim();
  const name = document.getElementById('name').value.trim();
  const sifa = document.getElementById('sifa').value.trim();
  const datum = document.getElementById('datum').value;

  const ma√ünahmen = [];
  antwortenMap.forEach((hinweis, frage) => {
    ma√ünahmen.push({ frage, beschreibung: hinweis });
  });

  const daten = { markt, name, sifa, datum, ma√ünahmen };
  const newWindow = window.open('massnahmen-2026.html', '_blank');
  const sendData = () => newWindow.postMessage(daten, '*');
  setTimeout(sendData, 500);
}

// Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('sw.js')
      .then(() => console.log("‚úÖ Service Worker registriert"))
      .catch((err) => console.error("‚ùå Service Worker Fehler:", err));
  });
}
</script>

</body>
</html>

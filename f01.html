<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arbeitssicherheit-Checkliste-2025</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.js"></script>
<link href="/sicher/favicon.ico" rel="icon" type="image/x-icon" />
<link href="/sicher/manifest.json" rel="manifest" />
<style>
  body {
    background-color: #d0e7ff;
    color: #212529;
    padding: 1rem;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    font-family: Arial, sans-serif;
    position: relative;
  }
  
  body.dark-mode {
    background-color: #121212;
    color: #eee;
  }
  
  body.dark-mode input,
  body.dark-mode select,
  body.dark-mode button,
  body.dark-mode textarea {
    background-color: #333;
    color: #eee;
    border-color: #555;
  }
  
  body.dark-mode label {
    color: #ccc;
  }

  .container-box {
    background-color: white;
    max-width: 800px;
    width: 100%;
    padding: 2rem 2rem 3rem 2rem;
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
    border-radius: 12px;
    box-sizing: border-box;
  }
  
  body.dark-mode .container-box {
    background-color: #1e1e1e;
    box-shadow: 0 0 20px rgba(255,255,255,0.1);
  }

  #vorschauContainer .img-wrapper {
    position: relative;
    display: inline-block;
    max-width: 150px;
    margin: 5px;
    vertical-align: top;
  }

  #vorschauContainer img {
    border-radius: 10px;
    max-height: 120px;
    width: 150px;
    object-fit: cover;
    display: block;
    margin-bottom: 5px;
  }
  
  #vorschauContainer textarea {
    width: 150px;
    resize: vertical;
    font-size: 0.9rem;
    padding: 4px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
    min-height: 50px;
  }

  .orientation-indicator {
    position: absolute;
    top: 30px;
    left: 5px;
    background-color: rgba(0, 123, 255, 0.9);
    color: white;
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 5;
  }

  .debug-info {
    position: absolute;
    bottom: 25px;
    left: 5px;
    background-color: rgba(255, 165, 0, 0.9);
    color: white;
    font-size: 8px;
    padding: 1px 3px;
    border-radius: 4px;
    font-weight: bold;
    z-index: 5;
  }

  .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: rgba(255, 0, 0, 0.8);
    color: white;
    font-weight: bold;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    z-index: 10;
    border: none;
  }

  .delete-btn:hover {
    background-color: rgba(255, 0, 0, 1);
  }

  @media (max-width: 768px) {
    .container-box {
      padding: 1.5rem 1rem 2rem 1rem;
      max-width: 100%;
    }
    
    #vorschauContainer img,
    #vorschauContainer textarea {
      max-height: 100px;
      width: 100px;
    }
    
    #vorschauContainer .img-wrapper {
      max-width: 100px;
    }
  }

  footer {
    font-size: 0.8rem;
    color: #666c7a;
    margin-top: 2.5rem;
  }
  
  body.dark-mode footer {
    color: #aaa;
  }

  #darkModeToggle {
    position: fixed;
    top: 1rem;
    right: 1rem;
    width: 36px;
    height: 36px;
    background: transparent;
    color: #004080;
    border: none;
    border-radius: 50%;
    font-size: 1rem;
    cursor: pointer;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  #darkModeToggle:hover {
    background-color: rgba(0, 64, 128, 0.1);
  }

  body.dark-mode #darkModeToggle {
    color: #ffd700;
  }

  #formatHinweis {
    position: fixed;
    top: 250px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    font-weight: bold;
    z-index: 2000;
    max-width: 600px;
    text-align: center;
    font-family: Arial, sans-serif;
    cursor: pointer;
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  .btn-loading {
    position: relative;
    pointer-events: none;
  }

  .btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<button id="darkModeToggle" aria-label="Dark Mode umschalten" title="Dark Mode umschalten">ðŸŒ™</button>

<div id="formatHinweis">
ðŸ“¸ iPad-Fix: Verbesserte Erkennung von Hoch- und Querformat mit Debug-Informationen.
<br><small>Klick zum SchlieÃŸen</small>
</div>

<div class="container-box">
<h1 class="mb-4 text-center">Arbeitssicherheit-Checkliste-2025</h1>

<form id="formular" class="mb-4">
  <div class="mb-3">
    <label for="datum" class="form-label">Datum:</label>
    <input type="date" id="datum" name="datum" class="form-control" required />
  </div>

  <div class="mb-3">
    <label for="marktnummer" class="form-label">Marktnummer:</label>
    <input type="text" id="marktnummer" name="marktnummer" class="form-control" placeholder="z.B. M123" required />
  </div>

  <div class="mb-3">
    <label for="name" class="form-label">Name:</label>
    <input type="text" id="name" name="name" class="form-control" placeholder="Ihr Name" required />
  </div>

  <div class="mb-3">
    <label for="sifa" class="form-label">SiFa:</label>
    <input type="text" id="sifa" name="sifa" class="form-control" placeholder="Sicherheitsfachkraft" required />
  </div>

  <div class="mb-3">
    <label class="form-label">Foto aufnehmen (Kamera):</label>
    <input type="file" id="foto" accept="image/*" capture="environment" multiple style="display:none;" />
    <button type="button" id="fotoBtn" class="btn btn-primary w-100">ðŸ“· Foto aufnehmen</button>
  </div>

  <div class="mb-3">
    <label for="upload" class="form-label">Dateien auswÃ¤hlen (Galerie):</label>
    <input type="file" id="upload" accept="image/*" multiple class="form-control" />
  </div>

  <div id="vorschauContainer" class="mb-3"></div>

  <button type="button" id="pdfSpeichern" class="btn btn-success w-100" onclick="speichernAlsPDF()">ðŸ’¾ Als PDF speichern</button>
  <button type="button" id="pdfTeilen" class="btn btn-info w-100 mt-2" onclick="pdfTeileniPad()">ðŸ“¤ PDF teilen (iPad)</button>
</form>

<footer class="text-center">
  &copy; <span id="jahr1"></span> Andreas Zott. Alle Rechte vorbehalten. (SiFa) Arbeitssicherheit <span id="jahr2"></span>
</footer>
</div>

<script>
const fotoInput = document.getElementById("foto");
const uploadInput = document.getElementById("upload");
const fotoButton = document.getElementById("fotoBtn");
const vorschauContainer = document.getElementById("vorschauContainer");
const darkModeToggle = document.getElementById("darkModeToggle");
let bilder = [];

// Dark Mode Toggle
darkModeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  darkModeToggle.textContent = document.body.classList.contains("dark-mode") ? "â˜€ï¸" : "ðŸŒ™";
  localStorage.setItem('darkMode', document.body.classList.contains("dark-mode"));
});

// Dark Mode aus localStorage laden
if (localStorage.getItem('darkMode') === 'true') {
  document.body.classList.add("dark-mode");
  darkModeToggle.textContent = "â˜€ï¸";
}

fotoButton.addEventListener("click", () => {
  fotoInput.click();
});

fotoInput.addEventListener("change", handleFile);
uploadInput.addEventListener("change", handleFile);

// Verbesserte Orientierungserkennung fÃ¼r iPad
function determineOrientation(originalWidth, originalHeight, finalWidth, finalHeight, exifOrientation) {
  console.log(`ðŸ” Orientierungsanalyse:
    Original: ${originalWidth}x${originalHeight} (Ratio: ${(originalWidth/originalHeight).toFixed(2)})
    Final: ${finalWidth}x${finalHeight} (Ratio: ${(finalWidth/finalHeight).toFixed(2)})
    EXIF: ${exifOrientation}`);
  
  // Mehrere Erkennungsmethoden kombinieren
  const originalRatio = originalWidth / originalHeight;
  const finalRatio = finalWidth / finalHeight;
  
  // Methode 1: EXIF-basierte Erkennung
  let exifBasedOrientation = 'unknown';
  if (exifOrientation) {
    if (exifOrientation === 6 || exifOrientation === 8) {
      // EXIF zeigt Rotation an - ursprÃ¼nglich war es wahrscheinlich Hochformat
      exifBasedOrientation = originalRatio > 1 ? 'portrait' : 'landscape';
    } else if (exifOrientation === 3) {
      // 180Â° Rotation - Orientierung bleibt gleich
      exifBasedOrientation = originalRatio > 1.3 ? 'landscape' : originalRatio < 0.75 ? 'portrait' : 'square';
    } else {
      // Keine Rotation
      exifBasedOrientation = originalRatio > 1.3 ? 'landscape' : originalRatio < 0.75 ? 'portrait' : 'square';
    }
  }
  
  // Methode 2: Final-Dimensionen-basierte Erkennung
  const finalBasedOrientation = finalRatio > 1.3 ? 'landscape' : finalRatio < 0.75 ? 'portrait' : 'square';
  
  // Methode 3: Original-Dimensionen-basierte Erkennung
  const originalBasedOrientation = originalRatio > 1.3 ? 'landscape' : originalRatio < 0.75 ? 'portrait' : 'square';
  
  console.log(`ðŸ“Š Erkennungsmethoden:
    EXIF-basiert: ${exifBasedOrientation}
    Final-basiert: ${finalBasedOrientation}
    Original-basiert: ${originalBasedOrientation}`);
  
  // Entscheidungslogik: Final-Dimensionen haben PrioritÃ¤t (nach EXIF-Korrektur)
  let finalOrientation = finalBasedOrientation;
  
  // Spezialfall fÃ¼r iPad: Wenn EXIF eine Rotation anzeigt, aber Final-Ratio nicht passt
  if (exifOrientation === 6 || exifOrientation === 8) {
    // Bei 90Â°-Rotation sollten die Dimensionen getauscht sein
    if (finalRatio > 1 && originalRatio < 1) {
      finalOrientation = 'landscape'; // War Hochformat, wurde zu Querformat
    } else if (finalRatio < 1 && originalRatio > 1) {
      finalOrientation = 'portrait'; // War Querformat, wurde zu Hochformat
    }
  }
  
  console.log(`âœ… Finale Orientierung: ${finalOrientation}`);
  return finalOrientation;
}

function handleFile(event) {
  const files = event.target.files;
  
  if (files.length === 0) return;

  for (const file of files) {
    if (file && file.type.startsWith("image/")) {
      if (bilder.length >= 16) {
        alert("Maximal 16 Bilder erlaubt.");
        break;
      }
      
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          console.log(`ðŸ“· Neues Bild geladen: ${img.width}x${img.height}`);
          
          try {
            if (typeof EXIF !== 'undefined' && EXIF.getData) {
              EXIF.getData(img, function () {
                const orientation = EXIF.getTag(this, "Orientation") || 1;
                console.log(`ðŸ”„ EXIF-Orientierung: ${orientation}`);
                processImageWithEXIF(img, e.target.result, orientation);
              });
            } else {
              console.log("âš ï¸ EXIF nicht verfÃ¼gbar, verwende Fallback");
              processImageSimple(img, e.target.result);
            }
          } catch (error) {
            console.warn("âŒ EXIF-Verarbeitung fehlgeschlagen:", error);
            processImageSimple(img, e.target.result);
          }
        };
        
        img.onerror = function() {
          console.error("Fehler beim Laden des Bildes");
          alert("Fehler beim Laden des Bildes. Bitte versuchen Sie es erneut.");
        };
        
        img.src = e.target.result;
      };
      
      reader.onerror = function() {
        console.error("Fehler beim Lesen der Datei");
        alert("Fehler beim Lesen der Datei. Bitte versuchen Sie es erneut.");
      };
      
      reader.readAsDataURL(file);
    }
  }
  
  event.target.value = "";
}

function processImageWithEXIF(img, imageSrc, exifOrientation) {
  const originalWidth = img.width;
  const originalHeight = img.height;
  
  try {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    
    // Canvas-Dimensionen basierend auf EXIF-Orientierung
    if (exifOrientation >= 5 && exifOrientation <= 8) {
      canvas.width = originalHeight;
      canvas.height = originalWidth;
    } else {
      canvas.width = originalWidth;
      canvas.height = originalHeight;
    }
    
    // Transformationen anwenden
    switch (exifOrientation) {
      case 2:
        ctx.translate(originalWidth, 0);
        ctx.scale(-1, 1);
        break;
      case 3:
        ctx.translate(originalWidth, originalHeight);
        ctx.rotate(Math.PI);
        break;
      case 4:
        ctx.translate(0, originalHeight);
        ctx.scale(1, -1);
        break;
      case 5:
        ctx.rotate(0.5 * Math.PI);
        ctx.scale(1, -1);
        ctx.translate(0, -originalHeight);
        break;
      case 6:
        ctx.rotate(0.5 * Math.PI);
        ctx.translate(0, -originalHeight);
        break;
      case 7:
        ctx.rotate(0.5 * Math.PI);
        ctx.translate(originalWidth, -originalHeight);
        ctx.scale(-1, 1);
        break;
      case 8:
        ctx.rotate(-0.5 * Math.PI);
        ctx.translate(-originalWidth, 0);
        break;
      default:
        break;
    }
    
    ctx.drawImage(img, 0, 0);
    const finalImage = canvas.toDataURL("image/jpeg", 0.8);
    
    // Orientierung nach EXIF-Korrektur bestimmen
    const orientation = determineOrientation(
      originalWidth, 
      originalHeight, 
      canvas.width, 
      canvas.height, 
      exifOrientation
    );
    
    bilder.push({ 
      src: finalImage, 
      kommentar: "",
      orientation: orientation,
      originalWidth: originalWidth,
      originalHeight: originalHeight,
      finalWidth: canvas.width,
      finalHeight: canvas.height,
      exifOrientation: exifOrientation,
      debugInfo: `${originalWidth}x${originalHeight}â†’${canvas.width}x${canvas.height} EXIF:${exifOrientation}`
    });
    
    renderVorschau();
  } catch (error) {
    console.warn("EXIF-Verarbeitung fehlgeschlagen:", error);
    processImageSimple(img, imageSrc);
  }
}

function processImageSimple(img, imageSrc) {
  const orientation = determineOrientation(img.width, img.height, img.width, img.height, null);
  
  bilder.push({ 
    src: imageSrc, 
    kommentar: "",
    orientation: orientation,
    originalWidth: img.width,
    originalHeight: img.height,
    finalWidth: img.width,
    finalHeight: img.height,
    exifOrientation: null,
    debugInfo: `${img.width}x${img.height} NoEXIF`
  });
  
  renderVorschau();
}

function renderVorschau() {
  vorschauContainer.innerHTML = "";
  
  if (bilder.length === 0) {
    vorschauContainer.innerHTML = '<p class="text-muted text-center">Keine Bilder ausgewÃ¤hlt</p>';
    return;
  }
  
  bilder.forEach((bildObj, index) => {
    const wrapper = document.createElement("div");
    wrapper.className = "img-wrapper";

    const imgElement = document.createElement("img");
    imgElement.src = bildObj.src;
    imgElement.alt = `Foto ${index + 1}`;
    imgElement.loading = "lazy";

    // Orientierungsanzeige
    const orientationIndicator = document.createElement("div");
    orientationIndicator.className = "orientation-indicator";
    const orientationText = bildObj.orientation === 'landscape' ? 'ðŸ“ Quer' : 
                           bildObj.orientation === 'portrait' ? 'ðŸ“± Hoch' : 'â¬œ Quad';
    orientationIndicator.textContent = orientationText;

    // Debug-Info
    const debugInfo = document.createElement("div");
    debugInfo.className = "debug-info";
    debugInfo.textContent = bildObj.debugInfo;

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "âœ–";
    deleteBtn.className = "delete-btn";
    deleteBtn.type = "button";
    deleteBtn.title = "Foto lÃ¶schen";
    deleteBtn.setAttribute('aria-label', `Foto ${index + 1} lÃ¶schen`);
    deleteBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (confirm("MÃ¶chten Sie dieses Foto wirklich lÃ¶schen?")) {
        bilder.splice(index, 1);
        renderVorschau();
      }
    });

    const kommentar = document.createElement("textarea");
    kommentar.placeholder = "Kommentar hier eingeben...";
    kommentar.value = bildObj.kommentar;
    kommentar.setAttribute('aria-label', `Kommentar fÃ¼r Foto ${index + 1}`);
    kommentar.addEventListener("input", (e) => {
      bilder[index].kommentar = e.target.value;
    });

    wrapper.appendChild(imgElement);
    wrapper.appendChild(orientationIndicator);
    wrapper.appendChild(debugInfo);
    wrapper.appendChild(deleteBtn);
    wrapper.appendChild(kommentar);
    vorschauContainer.appendChild(wrapper);
  });
}

function validateForm() {
  const datum = document.getElementById("datum").value;
  const marktnummer = document.getElementById("marktnummer").value;
  const name = document.getElementById("name").value;
  const sifa = document.getElementById("sifa").value;

  if (!datum || !marktnummer || !name || !sifa) {
    alert("Bitte fÃ¼llen Sie alle Pflichtfelder aus.");
    return false;
  }

  if (bilder.length === 0) {
    alert("Bitte fÃ¼gen Sie mindestens ein Foto hinzu.");
    return false;
  }

  return true;
}

function createPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });
  const margin = 40;
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  const datum = document.getElementById("datum").value;
  const marktnummer = document.getElementById("marktnummer").value;
  const name = document.getElementById("name").value;
  const sifa = document.getElementById("sifa").value;

  function drawHeader() {
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text("Arbeitssicherheit-Checkliste-2025", margin, margin + 20);
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text(`Datum: ${datum}`, margin, margin + 45);
    doc.text(`Marktnummer: ${marktnummer}`, margin + 200, margin + 45);
    doc.text(`Name: ${name}`, margin, margin + 60);
    doc.text(`SiFa: ${sifa}`, margin + 200, margin + 60);
    
    doc.setLineWidth(1);
    doc.line(margin, margin + 70, pageWidth - margin, margin + 70);
  }

  let currentPage = 0;
  let currentY = margin + 90;
  const availableWidth = pageWidth - margin * 2;
  const maxImageHeight = 300;

  for (let i = 0; i < bilder.length; i++) {
    const bildObj = bilder[i];
    
    if (currentPage === 0 || currentY + maxImageHeight + 100 > pageHeight - margin) {
      if (currentPage > 0) doc.addPage();
      drawHeader();
      currentY = margin + 90;
      currentPage++;
    }

    let imageWidth, imageHeight;
    
    // Orientierungsbasiertes Layout
    if (bildObj.orientation === 'portrait') {
      imageWidth = availableWidth * 0.5;
      imageHeight = maxImageHeight * 1.3;
    } else {
      imageWidth = availableWidth * 0.8;
      imageHeight = maxImageHeight * 0.8;
    }

    const x = margin + (availableWidth - imageWidth) / 2;

    try {
      const imgProps = doc.getImageProperties(bildObj.src);
      const ratio = imgProps.width / imgProps.height;
      
      let finalWidth = imageWidth;
      let finalHeight = finalWidth / ratio;
      
      if (finalHeight > imageHeight) {
        finalHeight = imageHeight;
        finalWidth = finalHeight * ratio;
      }

      const centerX = x + (imageWidth - finalWidth) / 2;
      
      doc.addImage(bildObj.src, "JPEG", centerX, currentY, finalWidth, finalHeight);
      
      if (bildObj.kommentar) {
        doc.setFontSize(9);
        const textLines = doc.splitTextToSize(bildObj.kommentar, imageWidth);
        doc.text(textLines, x, currentY + finalHeight + 20);
        currentY += finalHeight + 40 + (textLines.length * 12);
      } else {
        currentY += finalHeight + 30;
      }
      
    } catch (error) {
      console.error("Fehler beim HinzufÃ¼gen des Bildes:", error);
      currentY += 50;
    }
  }

  return doc;
}

function speichernAlsPDF() {
  if (!validateForm()) return;

  const button = document.getElementById("pdfSpeichern");
  button.classList.add("btn-loading");
  button.disabled = true;

  try {
    const doc = createPDF();
    const datum = document.getElementById("datum").value;
    const marktnummer = document.getElementById("marktnummer").value;
    const filename = `arbeitssicherheit-checkliste-${datum}-${marktnummer}.pdf`;
    doc.save(filename);
  } catch (error) {
    console.error("Fehler beim Erstellen des PDFs:", error);
    alert("Fehler beim Erstellen des PDFs. Bitte versuchen Sie es erneut.");
  } finally {
    button.classList.remove("btn-loading");
    button.disabled = false;
  }
}

async function pdfTeileniPad() {
  if (!validateForm()) return;

  const button = document.getElementById("pdfTeilen");
  button.classList.add("btn-loading");
  button.disabled = true;

  try {
    console.log("ðŸ”„ iPad PDF-Erstellung gestartet...");
    
    const doc = createPDF();
    const datum = document.getElementById("datum").value;
    const marktnummer = document.getElementById("marktnummer").value;
    const filename = `arbeitssicherheit-checkliste-${datum}-${marktnummer}.pdf`;
    
    const pdfBlob = doc.output("blob");
    console.log("âœ… Blob erstellt, GrÃ¶ÃŸe:", pdfBlob.size, "bytes");
    
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    if (navigator.share && navigator.canShare) {
      const file = new File([pdfBlob], filename, { 
        type: "application/pdf",
        lastModified: Date.now()
      });
      
      if (navigator.canShare({ files: [file] })) {
        await navigator.share({
          title: "Arbeitssicherheit Checkliste 2025",
          text: `Checkliste vom ${datum} (${marktnummer})`,
          files: [file]
        });
        console.log("âœ… PDF erfolgreich geteilt!");
        return;
      }
    }
    
    const url = URL.createObjectURL(pdfBlob);
    
    if (isIOS) {
      const newWindow = window.open(url, '_blank');
      if (newWindow) {
        setTimeout(() => {
          newWindow.document.title = filename;
        }, 100);
      } else {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
      }
    } else {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
    }
    
    setTimeout(() => URL.revokeObjectURL(url), 2000);
    alert("ðŸ“± PDF wurde fÃ¼r iPad optimiert bereitgestellt!");
    
  } catch (error) {
    console.error("âŒ Fehler:", error);
    alert("âŒ Fehler beim Erstellen oder Teilen des PDFs. Bitte versuchen Sie es erneut.");
  } finally {
    button.classList.remove("btn-loading");
    button.disabled = false;
  }
}

// Format-Hinweis automatisch ausblenden
const hinweis = document.getElementById("formatHinweis");
if (hinweis) {
  setTimeout(() => {
    hinweis.style.display = "none";
  }, 8000);
  
  hinweis.addEventListener("click", () => {
    hinweis.style.display = "none";
  });
}

// Datum auf heute setzen und Jahr in Footer
const datumInput = document.getElementById("datum");
const heute = new Date();
datumInput.value = heute.toISOString().split("T")[0];
document.getElementById("jahr1").textContent = heute.getFullYear();
document.getElementById("jahr2").textContent = heute.getFullYear();

// Initial-Rendering
renderVorschau();
</script>
</body>
</html>